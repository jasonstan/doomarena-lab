name: "Run REAL MVP"

on:
  workflow_dispatch:
    inputs:
      model:
        description: "Groq model id"
        required: true
        default: "llama-3.1-8b-instant"
      trials:
        description: "Trials per seed"
        required: true
        default: "3"
      seeds:
        description: "Comma-separated seeds"
        required: true
        default: "41,42"

# We only read the repo; no token write needed to upload artifacts
permissions:
  contents: read

jobs:
  real:
    name: "REAL Ï„-Bench risky (Groq)"
    if: ${{ github.repository_owner == 'jasonstan' }}
    runs-on: ubuntu-latest
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: make install

      - name: Real risky run + report
        env:
          REAL_MODEL: ${{ inputs.model }}
          TRIALS: ${{ inputs.trials }}
          SEEDS: ${{ inputs.seeds }}
        run: |
          set -euo pipefail
          # Single RUN_ID for this workflow trigger
          RUN_ID="$(date -u '+%Y%m%d-%H%M%S')"
          export RUN_ID
          echo "$RUN_ID" > results/.run_id

          # Run experiment and publish report (copies artifacts to results/)
          make real-tau-risky TRIALS="${TRIALS}" SEEDS="${SEEDS}" REAL_MODEL="${REAL_MODEL}"
          make report RUN_ID="${RUN_ID}"

      - name: Determine RUN_ID
        id: rid
        run: |
          RID="$(cat results/.run_id 2>/dev/null || true)"
          echo "run_id=$RID" >> "$GITHUB_OUTPUT"
          echo "RUN_ID=$RID"

      - name: Upload full RUN_DIR
        if: steps.rid.outputs.run_id != ''
        uses: actions/upload-artifact@v4
        with:
          name: run-${{ steps.rid.outputs.run_id }}
          path: results/${{ steps.rid.outputs.run_id }}/
          if-no-files-found: error
          retention-days: 14

      - name: Upload root artifacts (latest)
        uses: actions/upload-artifact@v4
        with:
          name: latest-artifacts
          path: |
            results/summary.csv
            results/summary.svg
            results/index.html
            results/run.json
          if-no-files-found: warn
          retention-days: 14
