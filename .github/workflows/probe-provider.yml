name: Probe provider

on:
  workflow_dispatch:
    inputs:
      provider:
        description: "Which provider to probe"
        required: true
        default: groq
        type: choice
        options: [groq, gemini]
      prompt:
        description: "Prompt to send"
        required: false
        default: "Say: hello from doomarena-lab"
      groq_model:
        description: "Groq model (OpenAI-compatible)"
        required: false
        default: "llama-3.1-8b-instant"

permissions:
  contents: read

jobs:
  probe:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Select provider
        run: |
          echo "Provider: ${{ inputs.provider }}"
          echo "Prompt:   ${{ inputs.prompt }}"
          echo "Groq model: ${{ inputs.groq_model }}"

      - name: Probe Groq (OpenAI-compatible)
        if: ${{ inputs.provider == 'groq' }}
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          MODEL: ${{ inputs.groq_model }}
          PROMPT: ${{ inputs.prompt }}
        run: |
          if [ -z "$GROQ_API_KEY" ]; then
            echo "::warning::GROQ_API_KEY is not set. Add it in Settings > Secrets and variables > Actions."
            exit 0
          fi
          echo "Calling Groq model: $MODEL"
          RESP="$(curl -sS https://api.groq.com/openai/v1/chat/completions \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"model\":\"$MODEL\",\"messages\":[{\"role\":\"user\",\"content\":\"$PROMPT\"}],\"max_tokens\":64}")" || {
            echo "::error::curl failed"
            exit 1
          }
          echo "RAW_RESPONSE_JSON<<EOF"
          echo "$RESP"
          echo "EOF"
          echo "$RESP" | python - <<'PY'
          import json, sys

          data = json.load(sys.stdin)
          error = data.get("error")
          if error:
              print(f"ERROR: {error}")
              sys.exit(1)

          msg = None
          choices = data.get("choices") or []
          if choices:
              msg = choices[0].get("message", {}).get("content")

          if msg:
              print(f"REPLY: {msg}")
          else:
              print("REPLY: <no content>")
              sys.exit(1)
          PY

      - name: Probe Gemini (REST)
        if: ${{ inputs.provider == 'gemini' }}
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PROMPT: ${{ inputs.prompt }}
        run: |
          if [ -z "$GOOGLE_API_KEY" ]; then
            echo "::warning::GOOGLE_API_KEY is not set. Add it in Settings > Secrets and variables > Actions."
            exit 0
          fi
          echo "Calling Gemini 1.5 Flash"
          RESP="$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GOOGLE_API_KEY" \
            -d "{\"contents\":[{\"parts\":[{\"text\":\"$PROMPT\"}]}]}")" || {
            echo "::error::curl failed"
            exit 1
          }
          echo "RAW_RESPONSE_JSON<<EOF"
          echo "$RESP"
          echo "EOF"
          echo "$RESP" | python - <<'PY'
          import json, sys

          data = json.load(sys.stdin)
          error = data.get("error")
          if error:
              print(f"ERROR: {error}")
              sys.exit(1)

          content_text = None
          candidates = data.get("candidates") or []
          if candidates:
              content = candidates[0].get("content") or {}
              parts = content.get("parts") or []
              if parts:
                  content_text = parts[0].get("text")

          if content_text:
              print(f"REPLY: {content_text}")
          else:
              print("REPLY: <no content>")
              sys.exit(1)
          PY
